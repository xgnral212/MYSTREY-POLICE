<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYSTREY LIFE - Police System</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* Add specific styles for the MDT layout here for quick access */
        .search-container {
            text-align: center;
            margin-bottom: 20px;
        }
        #searchInput {
            width: 70%;
            padding: 12px 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #333;
            color: #eee;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s ease;
        }
        #searchInput:focus {
            border-color: #E74C3C;
        }
        .profile-card {
            background-color: #2b2b2b;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .profile-card img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 50%;
            border: 3px solid #E74C3C;
            margin-bottom: 15px;
            object-fit: cover;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .profile-card h3 {
            color: #E74C3C;
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
        }
        .profile-info p {
            margin: 8px 0;
            color: #ccc;
            font-size: 1.1em;
        }
        .profile-info span {
            font-weight: bold;
            color: #f0f0f0;
        }

        .profile-section-title {
            color: #E74C3C;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            font-size: 1.5em;
        }
        .add-item-form {
            background-color: #2b2b2b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            margin-top: 15px;
        }
        .add-item-form input[type="text"],
        .add-item-form textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #3e3e3e;
            color: #eee;
        }
        .add-item-form input[type="text"]::placeholder,
        .add-item-form textarea::placeholder {
            color: #aaa;
        }
        .add-item-form .btn {
            width: auto;
            margin-top: 5px;
        }
        .record-item {
            background-color: #333;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            word-wrap: break-word; /* Ensure long text wraps */
            display: flex; /* For aligning text and delete button */
            justify-content: space-between; /* Space out content */
            align-items: center; /* Vertically align */
        }
        .record-item strong {
            color: #E74C3C;
        }
        .record-item p {
            margin: 5px 0;
            color: #ccc;
        }
        .record-item .btn { /* Style for delete button within record item */
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: #C0392B; /* Darker red for delete */
        }
        .record-item .btn:hover {
            background-color: #E74C3C;
        }

        .no-records {
            color: #aaa;
            text-align: center;
            font-style: italic;
        }

        /* New Person Form Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .new-person-form, .add-user-form {
            background: #222;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.4s ease-out;
            border: 1px solid #333;
        }
        .new-person-form h3, .add-user-form h3 {
            color: #E74C3C;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
        }
        .new-person-form label, .add-user-form label {
            display: block;
            margin-bottom: 8px;
            color: #f0f0f0;
            font-weight: bold;
        }
        .new-person-form input[type="text"],
        .new-person-form input[type="number"],
        .new-person-form input[type="url"],
        .add-user-form input[type="text"],
        .add-user-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #3e3e3e;
            color: #eee;
            font-size: 1em;
            outline: none;
        }
        .new-person-form input[type="text"]::placeholder,
        .new-person-form input[type="url"]::placeholder,
        .add-user-form input[type="text"]::placeholder,
        .add-user-form input[type="password"]::placeholder {
            color: #aaa;
        }
        .new-person-form .form-actions, .add-user-form .form-actions {
            text-align: right;
            margin-top: 20px;
        }
        .new-person-form .btn, .add-user-form .btn {
            margin-left: 10px;
        }
        .new-person-form .btn.cancel, .add-user-form .btn.cancel {
            background-color: #666;
        }
        .new-person-form .btn.cancel:hover, .add-user-form .btn.cancel:hover {
            background-color: #777;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #addPersonBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #E74C3C;
            color: #fff;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 2.5em;
            line-height: 1;
            text-align: center;
            padding: 0;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s, transform 0.2s;
            display: none; /* Hidden by default, shown when logged in to MDT */
        }
        #addPersonBtn:hover {
            background-color: #C0392B;
            transform: scale(1.05);
        }

        .points-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #2b2b2b;
            color: #E74C3C;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.3em;
            border: 1px solid #3a3a3a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: none; /* Hidden by default */
        }

        /* Login Form Styles */
        .login-form {
            text-align: center;
            padding: 30px;
            background-color: #2b2b2b;
            border-radius: 10px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #3a3a3a;
        }
        .login-form h2 {
            color: #E74C3C;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        .login-form input[type="text"],
        .login-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #3e3e3e;
            color: #eee;
            font-size: 1em;
            outline: none;
        }
        .login-form input[type="text"]::placeholder,
        .login-form input[type="password"]::placeholder {
            color: #aaa;
        }
        .login-form .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            margin-top: 10px;
        }
        #loginMessage {
            color: #E74C3C;
            margin-top: 15px;
            font-weight: bold;
        }

        /* Admin Panel Styles */
        .admin-controls {
            text-align: center;
            margin-bottom: 25px;
        }
        .user-list {
            margin-top: 20px;
            background-color: #2b2b2b;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #3a3a3a;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333;
            border: 1px solid #444;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .user-item:last-child {
            margin-bottom: 0;
        }
        .user-item span {
            color: #f0f0f0;
            font-size: 1.1em;
        }
        .user-item strong {
            color: #E74C3C;
        }
        .user-item .btn {
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #C0392B;
        }
        .user-item .btn:hover {
            background-color: #E74C3C;
        }
        .user-item .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <h1>POLICE RP - MDT SYSTEM</h1>
        <p>Maintain order and track criminal activity in the city.</p>
        <nav>
            <button class="nav-btn" data-target="logs">Logs</button>
            <button class="nav-btn" data-target="description">Description</button>
            <button class="nav-btn" data-target="mdt-system">MDT System</button>
            <button class="nav-btn" data-target="admin-panel" id="adminPanelNavBtn" style="display: none;">Admin Panel</button>
            <button class="nav-btn" data-target="login" id="loginNavBtn">Login</button>
            <button class="nav-btn" data-target="logout" id="logoutNavBtn" style="display: none;">Logout</button>
        </nav>
        <div class="points-display" id="playerPoints">Points: 0</div>
    </header>

    <main>
        <button id="addPersonBtn" style="display: none;">+</button>
        <section id="logs" class="page-section active">
            <div class="section-content">
                <h2>System Logs</h2>
                <p>This section would display system activities, arrests, and major events.</p>
                <div id="logsContent">
                    <p class="no-records">No recent logs.</p>
                </div>
            </div>
        </section>

        <section id="description" class="page-section">
            <div class="section-content">
                <h2>System Description</h2>
                <p>The MDT (Mobile Data Terminal) system is designed for law enforcement personnel to efficiently manage citizen data, track criminal records, and document legal proceedings within the Role Play environment.</p>
                <p>Features include:</p>
                <ul>
                    <li>Search for individuals by name or ID.</li>
                    <li>Create new profiles for citizens.</li>
                    <li>Add charges, fines, and assets to individual profiles.</li>
                    <li>Maintain a clear record of all interactions.</li>
                </ul>
            </div>
        </section>

        <section id="login" class="page-section">
            <div class="login-form">
                <h2>Officer Login</h2>
                <input type="text" id="usernameInput" placeholder="Username">
                <input type="password" id="passwordInput" placeholder="Password">
                <button id="loginBtn" class="btn">Login</button>
                <p id="loginMessage"></p>
            </div>
        </section>

        <section id="mdt-system" class="page-section">
            <div class="section-content">
                <h2>MDT Search & Profiles</h2>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search by Name or ID...">
                </div>

                <div id="profileDetails">
                    <p class="no-records" id="noProfileFound">Search for a person or add a new one.</p>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="page-section">
            <div class="section-content">
                <h2>Admin Panel - Manage Users</h2>
                <div class="admin-controls">
                    <button id="addUserBtn" class="btn">Add New User</button>
                </div>
                <div class="user-list" id="userList">
                    <p class="no-records">Loading users...</p>
                </div>
            </div>
        </section>

        <div class="overlay" id="newPersonOverlay">
            <div class="new-person-form">
                <h3>Add New Person to System</h3>
                <label for="personName">Full Name:</label>
                <input type="text" id="personName" placeholder="Enter full name" required>

                <label for="personID">New ID Number:</label>
                <input type="text" id="personID" placeholder="Enter unique ID (e.g., 1234)" required>

                <label for="personImage">Image URL (Optional):</label>
                <input type="url" id="personImage" placeholder="e.g., https://example.com/image.jpg">

                <label for="personAge">Age:</label>
                <input type="number" id="personAge" placeholder="Enter age" min="0">

                <label for="personPhone">Phone Number (Optional):</label>
                <input type="text" id="personPhone" placeholder="Enter phone number">

                <div class="form-actions">
                    <button id="createPersonBtn" class="btn">Create Person</button>
                    <button id="cancelPersonBtn" class="btn cancel">Cancel</button>
                </div>
            </div>
        </div>

        <div class="overlay" id="addUserOverlay">
            <div class="add-user-form">
                <h3>Create New Officer Account</h3>
                <label for="newUsernameInput">Username:</label>
                <input type="text" id="newUsernameInput" placeholder="Enter new username" required>

                <label for="newUserPasswordInput">Password:</label>
                <input type="password" id="newUserPasswordInput" placeholder="Enter new password" required>

                <div class="form-actions">
                    <button id="createUserBtn" class="btn">Create Account</button>
                    <button id="cancelCreateUserBtn" class="btn cancel">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Police RP. All rights reserved.</p>
    </footer>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAvvgL7711HOC1IHVqyNiNC7N3HIqP2JMo",
            authDomain: "policerp-a71c8.firebaseapp.com",
            projectId: "policerp-a71c8",
            storageBucket: "policerp-a71c8.firebasestorage.app",
            messagingSenderId: "569720054342",
            appId: "1:569720054342:web:2d913aba81643bdc9ca047",
            measurementId: "G-4NZTMPCRR8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app); // Get Firestore instance

        // ----------------------------------------------------
        // Global variables and UI elements
        // ----------------------------------------------------
        let isLoggedIn = false;
        let currentOfficerUsername = '';
        let currentOfficerRole = 'officer'; // 'officer' or 'admin'
        let currentPersonFirestoreId = null; // To track the currently displayed person's Firestore ID

        const pages = document.querySelectorAll('.page-section');
        const navButtons = document.querySelectorAll('.nav-btn');
        const loginForm = document.querySelector('.login-form');
        const mdtSystemSection = document.getElementById('mdt-system');
        const addPersonBtn = document.getElementById('addPersonBtn');
        const newPersonOverlay = document.getElementById('newPersonOverlay');
        const addPersonForm = document.querySelector('.new-person-form');
        const createPersonBtn = document.getElementById('createPersonBtn');
        const cancelPersonBtn = document.getElementById('cancelPersonBtn');
        const searchInput = document.getElementById('searchInput');
        const profileDetails = document.getElementById('profileDetails');
        const loginBtn = document.getElementById('loginBtn');
        const logoutNavBtn = document.getElementById('logoutNavBtn');
        const loginNavBtn = document.getElementById('loginNavBtn');
        const adminPanelNavBtn = document.getElementById('adminPanelNavBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserOverlay = document.getElementById('addUserOverlay');
        const createUserBtn = document.getElementById('createUserBtn');
        const cancelCreateUserBtn = document.getElementById('cancelCreateUserBtn');
        const userList = document.getElementById('userList');
        const playerPointsDisplay = document.getElementById('playerPoints');

        // ----------------------------------------------------
        // Navigation and page display functions
        // ----------------------------------------------------
        function showPage(id) {
            pages.forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(id).style.display = 'block';

            // Show/hide add person button and player points based on page and login status
            if (id === 'mdt-system' && isLoggedIn) {
                addPersonBtn.style.display = 'block';
                playerPointsDisplay.style.display = 'block';
            } else {
                addPersonBtn.style.display = 'none';
                playerPointsDisplay.style.display = 'none';
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.dataset.target;
                if (targetId === 'logout') {
                    handleLogout();
                } else {
                    showPage(targetId);
                }
            });
        });

        // Show login page on initial load
        showPage('login');

        // ----------------------------------------------------
        // Login and Authentication functions (using Firebase Firestore for users)
        // ----------------------------------------------------

        // Function to fetch users from Firestore
        async function getUsersFromFirestore() {
            const usersCol = collection(db, "users");
            const userSnapshot = await getDocs(usersCol);
            const usersList = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return usersList;
        }

        // Login function
        loginBtn.addEventListener('click', async () => {
            const usernameInput = document.getElementById('usernameInput').value;
            const passwordInput = document.getElementById('passwordInput').value;
            const loginMessage = document.getElementById('loginMessage');

            if (!usernameInput || !passwordInput) {
                loginMessage.textContent = 'Please enter both username and password.';
                return;
            }

            const users = await getUsersFromFirestore();
            const user = users.find(u => u.username === usernameInput && u.password === passwordInput); // WARNING: Password stored in plain text! Should be hashed in a real app.

            if (user) {
                isLoggedIn = true;
                currentOfficerUsername = user.username;
                currentOfficerRole = user.role || 'officer'; // Default to 'officer'
                loginMessage.textContent = `Welcome, ${currentOfficerUsername}!`;

                // Update button and menu visibility
                loginNavBtn.style.display = 'none';
                logoutNavBtn.style.display = 'inline-block';
                if (currentOfficerRole === 'admin') {
                    adminPanelNavBtn.style.display = 'inline-block';
                } else {
                    adminPanelNavBtn.style.display = 'none';
                }

                // Show MDT page after login
                showPage('mdt-system');
            } else {
                loginMessage.textContent = 'Invalid username or password.';
            }
        });

        // Logout function
        function handleLogout() {
            isLoggedIn = false;
            currentOfficerUsername = '';
            currentOfficerRole = 'officer';
            loginNavBtn.style.display = 'inline-block';
            logoutNavBtn.style.display = 'none';
            adminPanelNavBtn.style.display = 'none';
            addPersonBtn.style.display = 'none';
            playerPointsDisplay.style.display = 'none'; // Hide player points on logout
            showPage('login');
            document.getElementById('loginMessage').textContent = ''; // Clear login message
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        // ----------------------------------------------------
        // Admin Panel functions
        // ----------------------------------------------------

        adminPanelNavBtn.addEventListener('click', async () => {
            if (currentOfficerRole === 'admin') {
                await renderUserList();
                showPage('admin-panel');
            } else {
                alert('You do not have permission to access the admin panel.');
                showPage('mdt-system'); // Redirect to MDT page
            }
        });

        addUserBtn.addEventListener('click', () => {
            if (currentOfficerRole === 'admin') {
                addUserOverlay.style.display = 'flex';
            } else {
                alert('You do not have permission to add users.');
            }
        });

        cancelCreateUserBtn.addEventListener('click', () => {
            addUserOverlay.style.display = 'none';
            document.getElementById('newUsernameInput').value = '';
            document.getElementById('newUserPasswordInput').value = '';
        });

        createUserBtn.addEventListener('click', async () => {
            const newUsername = document.getElementById('newUsernameInput').value;
            const newPassword = document.getElementById('newUserPasswordInput').value;

            if (!newUsername || !newPassword) {
                alert('Please enter a username and password for the new user.');
                return;
            }

            try {
                await addDoc(collection(db, "users"), {
                    username: newUsername,
                    password: newPassword, // WARNING: This stores password in plain text! Hash it in a real app.
                    role: 'officer' // Default role for new user
                });
                alert('User added successfully!');
                addUserOverlay.style.display = 'none';
                document.getElementById('newUsernameInput').value = '';
                document.getElementById('newUserPasswordInput').value = '';
                await renderUserList(); // Update user list
            } catch (e) {
                console.error("Error adding user: ", e);
                alert('Failed to add user.');
            }
        });

        async function renderUserList() {
            userList.innerHTML = '<p class="no-records">Loading users...</p>';
            const users = await getUsersFromFirestore();
            if (users.length > 0) {
                userList.innerHTML = '';
                users.forEach(user => {
                    if (user.username !== currentOfficerUsername) { // Don't allow deleting the current user
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <span>Username: <strong>${user.username}</strong> (Role: ${user.role || 'officer'})</span>
                            <button class="btn delete-user-btn" data-user-id="${user.id}">Delete</button>
                        `;
                        userList.appendChild(userItem);
                    }
                });
                // Add event listeners for delete buttons
                userList.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userIdToDelete = e.target.dataset.userId;
                        if (confirm('Are you sure you want to delete this user?')) {
                            try {
                                await deleteDoc(doc(db, "users", userIdToDelete));
                                alert('User deleted successfully!');
                                await renderUserList(); // Refresh list
                            } catch (e) {
                                console.error("Error deleting user: ", e);
                                alert('Failed to delete user.');
                            }
                        }
                    });
                });
            } else {
                userList.innerHTML = '<p class="no-records">No users found.</p>';
            }
        }

        // ----------------------------------------------------
        // MDT functions (Add, Search, Display, Delete Records)
        // ----------------------------------------------------

        // Function to add a new person to Firestore
        async function addNewPersonToFirestore(personData) {
            try {
                const docRef = await addDoc(collection(db, "persons"), personData);
                console.log("Person added with ID: ", docRef.id);
                return { id: docRef.id, ...personData }; // Return added person with Firebase ID
            } catch (e) {
                console.error("Error adding person: ", e);
                return null;
            }
        }

        // Function to search for a person by name or ID
        async function searchPersonInFirestore(searchTerm) {
            const personsCol = collection(db, "persons");
            let personData = null;
            let personId = null;

            // Try searching by personID first if it's numeric
            if (!isNaN(searchTerm) && searchTerm.trim() !== '') {
                const qById = query(personsCol, where("personID", "==", searchTerm));
                const querySnapshotById = await getDocs(qById);
                if (!querySnapshotById.empty) {
                    personId = querySnapshotById.docs[0].id;
                    personData = querySnapshotById.docs[0].data();
                    return { id: personId, ...personData };
                }
            }

            // If not found by ID, try searching by name
            const qByName = query(personsCol, where("name", "==", searchTerm));
            const querySnapshotByName = await getDocs(qByName);
            if (!querySnapshotByName.empty) {
                personId = querySnapshotByName.docs[0].id;
                personData = querySnapshotByName.docs[0].data();
                return { id: personId, ...personData };
            }

            return null; // Person not found
        }

        // Function to add a record (Charge/Asset) for a specific person
        async function addRecordToPerson(personFirestoreId, recordType, recordData) {
            // recordType can be "charges" or "assets"
            try {
                const docRef = await addDoc(collection(db, "persons", personFirestoreId, recordType), recordData);
                console.log(`Added ${recordType} with ID: `, docRef.id);
                return { id: docRef.id, ...recordData };
            } catch (e) {
                console.error(`Error adding ${recordType}: `, e);
                return null;
            }
        }

        // Function to fetch all records (Charges/Assets) for a specific person
        async function getRecordsForPerson(personFirestoreId, recordType) {
            const recordsCol = collection(db, "persons", personFirestoreId, recordType);
            const recordsSnapshot = await getDocs(recordsCol);
            const recordsList = recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return recordsList;
        }

        // Function to delete a specific record for a specific person
        async function deleteRecordForPerson(personFirestoreId, recordType, recordFirestoreId) {
            try {
                await deleteDoc(doc(db, "persons", personFirestoreId, recordType, recordFirestoreId));
                console.log("Record deleted successfully!");
                return true;
            } catch (e) {
                console.error("Error deleting record: ", e);
                return false;
            }
        }

        // Function to update a person's points
        async function updatePersonPoints(personFirestoreId, points) {
            try {
                const personRef = doc(db, "persons", personFirestoreId);
                await updateDoc(personRef, {
                    points: points
                });
                console.log("Points updated successfully!");
                return true;
            } catch (e) {
                console.error("Error updating points: ", e);
                return false;
            }
        }


        // ----------------------------------------------------
        // MDT Event Listeners
        // ----------------------------------------------------

        addPersonBtn.addEventListener('click', () => {
            if (isLoggedIn) {
                newPersonOverlay.style.display = 'flex';
            } else {
                alert('You must be logged in to add a person.');
            }
        });

        cancelPersonBtn.addEventListener('click', () => {
            newPersonOverlay.style.display = 'none';
            addPersonForm.reset(); // Clear form fields
        });

        createPersonBtn.addEventListener('click', async () => {
            const name = document.getElementById('personName').value.trim();
            const personID = document.getElementById('personID').value.trim();
            const imageUrl = document.getElementById('personImage').value.trim();
            const age = document.getElementById('personAge').value.trim();
            const phone = document.getElementById('personPhone').value.trim();

            if (!name || !personID) {
                alert('Name and ID are required.');
                return;
            }

            // Check if ID already exists
            const existingPerson = await searchPersonInFirestore(personID);
            if (existingPerson) {
                alert('A person with this ID already exists. Please use a unique ID.');
                return;
            }

            const newPersonData = {
                name: name,
                personID: personID,
                imageUrl: imageUrl || 'https://via.placeholder.com/120x120?text=No+Image', // Default image
                age: parseInt(age) || 0,
                phone: phone || 'N/A',
                points: 0, // Initial points
                createdAt: new Date().toISOString() // For tracking
            };

            const addedPerson = await addNewPersonToFirestore(newPersonData);
            if (addedPerson) {
                alert('Person added successfully!');
                newPersonOverlay.style.display = 'none';
                addPersonForm.reset();
                // Optionally, display the added person or trigger a new search
                searchInput.value = addedPerson.personID;
                searchInput.dispatchEvent(new Event('input')); // Trigger search automatically
            } else {
                alert('Failed to add person. Please try again.');
            }
        });

        searchInput.addEventListener('input', async (e) => {
            if (!isLoggedIn) {
                profileDetails.innerHTML = '<p class="no-records">Please log in to use the MDT system.</p>';
                return;
            }

            const searchTerm = e.target.value.trim();
            profileDetails.innerHTML = ''; // Clear old content

            if (searchTerm.length >= 1) { // Start search after at least 1 character
                const foundPerson = await searchPersonInFirestore(searchTerm);
                if (foundPerson) {
                    currentPersonFirestoreId = foundPerson.id; // Store Firebase ID
                    await renderPersonProfile(foundPerson);
                } else {
                    profileDetails.innerHTML = '<p class="no-records" id="noProfileFound">No person found with that ID or name. Try a different search or add a new one.</p>';
                }
            } else {
                profileDetails.innerHTML = '<p class="no-records" id="noProfileFound">Search for a person or add a new one.</p>';
            }
        });

        // Function to render person profile
        async function renderPersonProfile(person) {
            const charges = await getRecordsForPerson(person.id, 'charges');
            const assets = await getRecordsForPerson(person.id, 'assets');

            let profileHtml = `
                <div class="profile-card" data-person-firestore-id="${person.id}">
                    <img src="${person.imageUrl}" alt="Profile Image">
                    <h3>${person.name}</h3>
                    <div class="profile-info">
                        <p>ID: <span>${person.personID}</span></p>
                        <p>Age: <span>${person.age}</span></p>
                        <p>Phone: <span>${person.phone}</span></p>
                        <p>Points: <span id="currentPersonPoints">${person.points || 0}</span></p>
                        <button class="btn" id="addPointsBtn">+5 Points</button>
                        <button class="btn" id="removePointsBtn">-5 Points</button>
                    </div>

                    <h4 class="profile-section-title">Charges/Violations</h4>
                    <div id="chargesList"></div>
                    <div class="add-item-form">
                        <input type="text" id="newChargeTitle" placeholder="Charge Title" required>
                        <textarea id="newChargeDetails" placeholder="Charge Details" required></textarea>
                        <button class="btn add-record-btn" data-record-type="charges">Add Charge</button>
                    </div>

                    <h4 class="profile-section-title">Assets</h4>
                    <div id="assetsList"></div>
                    <div class="add-item-form">
                        <input type="text" id="newAssetItem" placeholder="Asset Item" required>
                        <textarea id="newAssetDetails" placeholder="Asset Details" required></textarea>
                        <button class="btn add-record-btn" data-record-type="assets">Add Asset</button>
                    </div>
                </div>
            `;
            profileDetails.innerHTML = profileHtml;

            const chargesListDiv = document.getElementById('chargesList');
            chargesListDiv.innerHTML = charges.map(charge => `
                <div class="record-item" data-record-id="${charge.id}" data-record-type="charges">
                    <div><strong>${charge.title}</strong><p>${charge.details} <small>(${new Date(charge.timestamp).toLocaleDateString()})</small></p></div>
                    <button class="btn delete-record-btn">Delete</button>
                </div>
            `).join('') || '<p class="no-records">No charges found.</p>';

            const assetsListDiv = document.getElementById('assetsList');
            assetsListDiv.innerHTML = assets.map(asset => `
                <div class="record-item" data-record-id="${asset.id}" data-record-type="assets">
                    <div><strong>${asset.item}</strong><p>${asset.details} <small>(${new Date(asset.timestamp).toLocaleDateString()})</small></p></div>
                    <button class="btn delete-record-btn">Delete</button>
                </div>
            `).join('') || '<p class="no-records">No assets found.</p>';

            // Event listeners for add record buttons
            profileDetails.querySelectorAll('.add-record-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!currentPersonFirestoreId) return;

                    const recordType = e.target.dataset.recordType;
                    let recordData = {};

                    if (recordType === 'charges') {
                        const title = document.getElementById('newChargeTitle').value.trim();
                        const details = document.getElementById('newChargeDetails').value.trim();
                        if (!title || !details) {
                            alert('Please fill in both title and details for the charge.');
                            return;
                        }
                        recordData = {
                            title: title,
                            details: details,
                            timestamp: new Date().toISOString()
                        };
                    } else if (recordType === 'assets') {
                        const item = document.getElementById('newAssetItem').value.trim();
                        const details = document.getElementById('newAssetDetails').value.trim();
                        if (!item || !details) {
                            alert('Please fill in both item and details for the asset.');
                            return;
                        }
                        recordData = {
                            item: item,
                            details: details,
                            timestamp: new Date().toISOString()
                        };
                    }

                    const addedRecord = await addRecordToPerson(currentPersonFirestoreId, recordType, recordData);
                    if (addedRecord) {
                        // Update record display after adding
                        await renderPersonProfile(person); // Re-render the entire profile to refresh records
                        // Clear input fields
                        if (recordType === 'charges') {
                            document.getElementById('newChargeTitle').value = '';
                            document.getElementById('newChargeDetails').value = '';
                        } else if (recordType === 'assets') {
                            document.getElementById('newAssetItem').value = '';
                            document.getElementById('newAssetDetails').value = '';
                        }
                    } else {
                        alert('Failed to add record. Please try again.');
                    }
                });
            });

            // Event listeners for delete record buttons
            profileDetails.querySelectorAll('.delete-record-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!currentPersonFirestoreId) return;

                    const recordItem = e.target.closest('.record-item');
                    const recordId = recordItem.dataset.recordId;
                    const recordType = recordItem.dataset.recordType; // charges or assets

                    if (confirm(`Are you sure you want to delete this ${recordType.slice(0, -1)} record?`)) {
                        const success = await deleteRecordForPerson(currentPersonFirestoreId, recordType, recordId);
                        if (success) {
                            recordItem.remove(); // Remove element from UI
                            // Optionally, re-fetch and update points if deleting record affects them
                        } else {
                            alert('Failed to delete record. Please try again.');
                        }
                    }
                });
            });

            // Event listeners for points buttons
            document.getElementById('addPointsBtn').addEventListener('click', async () => {
                if (!currentPersonFirestoreId) return;
                let currentPoints = parseInt(document.getElementById('currentPersonPoints').textContent);
                currentPoints += 5;
                const success = await updatePersonPoints(currentPersonFirestoreId, currentPoints);
                if (success) {
                    document.getElementById('currentPersonPoints').textContent = currentPoints;
                    playerPointsDisplay.textContent = `Points: ${currentPoints}`; // Update points in top display
                }
            });

            document.getElementById('removePointsBtn').addEventListener('click', async () => {
                if (!currentPersonFirestoreId) return;
                let currentPoints = parseInt(document.getElementById('currentPersonPoints').textContent);
                currentPoints = Math.max(0, currentPoints - 5); // Points cannot go below 0
                const success = await updatePersonPoints(currentPersonFirestoreId, currentPoints);
                if (success) {
                    document.getElementById('currentPersonPoints').textContent = currentPoints;
                    playerPointsDisplay.textContent = `Points: ${currentPoints}`; // Update points in top display
                }
            });
        }
    </script>
</body>
</html>
